<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Pfaff Wine Collection</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <style>
       body {
           background-color: #F5E8D3; /* Warm beige for wine cellar vibe */
       }
       table {
           border-collapse: collapse;
           width: 100%;
           margin-top: 20px;
           background-color: #FDF6E8; /* Soft ivory for table background */
           border: 1px solid #8B728E; /* Grayish-purple for grapevine border */
           box-shadow: 0 4px 12px rgba(75, 28, 42, 0.1);
       }
       th, td {
           border: 1px solid #8B728E;
           padding: 12px;
           text-align: left;
       }
       th {
           background-color: #7A2D3A; /* Merlot for header */
           color: #FDF6E8; /* Off-white text */
           cursor: pointer;
           font-weight: 600;
           transition: background-color 0.3s ease;
       }
       th:hover {
           background-color: #4A1C2A; /* Darker burgundy on hover */
       }
       td {
           background-color: #FDF6E8;
           color: #2A2A2A; /* Dark charcoal for text */
       }
       select {
           width: 100%;
           padding: 10px 36px 10px 12px;
           border: 1px solid #8B728E;
           border-radius: 8px;
           background-color: #FDF6E8;
           font-size: 0.875rem;
           color: #2A2A2A;
           appearance: none;
           background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%234A1C2A'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
           background-repeat: no-repeat;
           background-position: right 12px center;
           background-size: 18px;
           transition: all 0.3s ease-in-out;
           box-shadow: 0 2px 4px rgba(75, 28, 42, 0.1);
       }
       select:hover {
           border-color: #D4A017; /* Gold accent on hover */
           box-shadow: 0 0 0 3px rgba(212, 160, 23, 0.2);
       }
       select:focus {
           outline: none;
           border-color: #4A1C2A; /* Burgundy on focus */
           box-shadow: 0 0 0 3px rgba(74, 28, 42, 0.2);
           background-color: #F5E8D3;
       }
       label {
           font-size: 0.875rem;
           font-weight: 500;
           color: #2A2A2A;
           margin-bottom: 4px;
       }
       .filter-div {
           flex: 1 1 0;
           min-width: 200px;
           max-width: 300px;
       }
       .sort-indicator {
           display: inline-block;
           margin-left: 8px;
           font-size: 0.75rem;
           color: #D4A017; /* Gold for sort arrows */
       }
       .page-btn {
           margin-top: 16px;
           margin-right: 8px;
           padding: 8px 16px;
           background-color: #4A1C2A; /* Burgundy for buttons */
           color: #FDF6E8;
           border-radius: 6px;
           cursor: pointer;
           font-size: 0.875rem;
           transition: background-color 0.3s ease;
           box-shadow: 0 2px 4px rgba(75, 28, 42, 0.2);
       }
       .page-btn:hover {
           background-color: #D4A017; /* Gold on hover */
           color: #2A2A2A;
       }
       .page-btn:disabled {
           background-color: #8B728E;
           color: #FDF6E8;
           cursor: not-allowed;
           box-shadow: none;
       }
   </style>
</head>
<body class="p-4">
   <h1 class="text-3xl font-bold mb-4 text-center" style="color: #4A1C2A; text-shadow: 1px 1px 2px rgba(212, 160, 23, 0.3);">Pfaff Wine Collection</h1>
   <div id="filterContainer" class="mb-4">
       <div id="filterRow1" class="flex gap-4 mb-4 w-full"></div>
       <div id="filterRow2" class="flex gap-4 mb-4 w-full"></div>
       <div class="flex items-center gap-4 mt-4">
           <label for="resultsPerPage" class="text-sm font-medium" style="color: #2A2A2A;">Results per page:</label>
           <select id="resultsPerPage" class="w-24 p-2 border rounded-md">
               <option value="50">50</option>
               <option value="100">100</option>
               <option value="all">All</option>
           </select>
       </div>
   </div>
   <table id="dataTable">
       <thead id="tableHeader"></thead>
       <tbody id="tableBody"></tbody>
   </table>
   <div class="mt-4">
       <button id="prevPageBtn" class="page-btn" style="display: none;">Previous Page</button>
       <button id="nextPageBtn" class="page-btn" style="display: none;">Next Page</button>
   </div>

   <script>
       const API_KEY = 'AIzaSyAnSTomtKZVXIYkILwsK6IPCLT30G6jsF0';
       const SPREADSHEET_ID = '1njSXZyfEiT2_4EkGrK5XV6X3HPqgOJVLQUmWFR-LLP8';
       const RANGE = 'Sheet1!A1:H350';
       const FILTER_ORDER_ROW1 = ['Style', 'Year', 'Winery'];
       const FILTER_ORDER_ROW2 = ['Name', 'Contributor'];
       const FILTER_ORDER = [...FILTER_ORDER_ROW1, ...FILTER_ORDER_ROW2];

       let allData = [];
       let headers = [];
       let currentPage = 1;
       let resultsPerPage = 50;
       let sortColumn = null;
       let sortDirection = 'asc';

       async function fetchSheetData() {
           try {
               const response = await fetch(
                   `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`
               );
               const data = await response.json();
               if (data.values) {
                   // Original headers from the sheet
                   let originalHeaders = data.values[0];
                   // Rename 'Brand' to 'Winery' if it exists
                   const brandIndex = originalHeaders.indexOf('Brand');
                   if (brandIndex !== -1) {
                       originalHeaders[brandIndex] = 'Winery';
                   }
                   // Reorder headers: move Number to the end and rename to Amount
                   const numberIndex = originalHeaders.indexOf('Number');
                   if (numberIndex !== -1) {
                       originalHeaders = [
                           ...originalHeaders.slice(0, numberIndex),
                           ...originalHeaders.slice(numberIndex + 1),
                           'Amount'
                       ];
                   }
                   headers = originalHeaders;
                   allData = data.values.slice(1).map(row => {
                       // Reorder row data to match new header order
                       let reorderedRow = [...row];
                       if (numberIndex !== -1) {
                           const numberValue = reorderedRow.splice(numberIndex, 1)[0];
                           reorderedRow.push(numberValue || '');
                       }
                       return headers.reduce((obj, header, index) => {
                           obj[header] = reorderedRow[index] || '';
                           return obj;
                       }, {});
                   });
                   renderTable();
                   createFilters();
               } else {
                   console.error('No data found in the sheet');
               }
           } catch (error) {
               console.error('Error fetching data:', error);
           }
       }

       function getFilteredData() {
           const filters = FILTER_ORDER.reduce((acc, header) => {
               if (headers.includes(header)) {
                   const select = document.getElementById(`filter-${header}`);
                   acc[header] = select ? select.value : '';
               }
               return acc;
           }, {});

           let filteredData = allData.filter(row =>
               FILTER_ORDER.every(header =>
                   !filters[header] || row[header] === filters[header]
               )
           );

           // Apply sorting if a sort column is selected
           if (sortColumn) {
               filteredData.sort((a, b) => {
                   const valueA = a[sortColumn] || '';
                   const valueB = b[sortColumn] || '';
                   // Handle numerical sorting for 'Amount' column
                   if (sortColumn === 'Amount') {
                       const numA = parseFloat(valueA) || 0;
                       const numB = parseFloat(valueB) || 0;
                       return sortDirection === 'asc' ? numA - numB : numB - numA;
                   }
                   // Alphabetical sorting for other columns
                   return sortDirection === 'asc'
                       ? valueA.localeCompare(valueB)
                       : valueB.localeCompare(valueA);
               });
           }

           return filteredData;
       }

       function createFilters() {
           const filterRow1 = document.getElementById('filterRow1');
           const filterRow2 = document.getElementById('filterRow2');
           filterRow1.innerHTML = '';
           filterRow2.innerHTML = '';

           FILTER_ORDER_ROW1.forEach(header => {
               if (headers.includes(header)) {
                   const select = document.createElement('select');
                   select.id = `filter-${header}`;
                   select.addEventListener('change', () => {
                       currentPage = 1; // Reset to first page on filter change
                       filterTable();
                       updateFilterOptions();
                   });
                  
                   const div = document.createElement('div');
                   div.className = 'filter-div';
                   div.innerHTML = `<label class="block">${header}</label>`;
                   div.appendChild(select);
                   filterRow1.appendChild(div);
               }
           });

           FILTER_ORDER_ROW2.forEach(header => {
               if (headers.includes(header)) {
                   const select = document.createElement('select');
                   select.id = `filter-${header}`;
                   select.addEventListener('change', () => {
                       currentPage = 1; // Reset to first page on filter change
                       filterTable();
                       updateFilterOptions();
                   });
                  
                   const div = document.createElement('div');
                   div.className = 'filter-div';
                   div.innerHTML = `<label class="block">${header}</label>`;
                   div.appendChild(select);
                   filterRow2.appendChild(div);
               }
           });

           // Add event listener for results per page
           const resultsSelect = document.getElementById('resultsPerPage');
           resultsSelect.addEventListener('change', () => {
               resultsPerPage = resultsSelect.value === 'all' ? Infinity : parseInt(resultsSelect.value);
               currentPage = 1; // Reset to first page
               filterTable();
           });

           // Add event listeners for page buttons
           const prevPageBtn = document.getElementById('prevPageBtn');
           const nextPageBtn = document.getElementById('nextPageBtn');
           prevPageBtn.addEventListener('click', () => {
               if (currentPage > 1) {
                   currentPage--;
                   filterTable();
               }
           });
           nextPageBtn.addEventListener('click', () => {
               currentPage++;
               filterTable();
           });

           updateFilterOptions();
       }

       function updateFilterOptions() {
           const filteredData = getFilteredData();
           FILTER_ORDER.forEach(header => {
               if (headers.includes(header)) {
                   const select = document.getElementById(`filter-${header}`);
                   const currentValue = select.value;
                   const otherFilters = FILTER_ORDER.reduce((acc, h) => {
                       if (h !== header && headers.includes(h)) {
                           const s = document.getElementById(`filter-${h}`);
                           if (s && s.value) acc[h] = s.value;
                       }
                       return acc;
                   }, {});
                  
                   const relevantData = allData.filter(row =>
                       Object.keys(otherFilters).every(h => row[h] === otherFilters[h])
                   );
                   const uniqueValues = [...new Set(relevantData.map(row => row[header]))]
                       .filter(value => value !== '')
                       .sort();
                  
                   // Pluralize filter labels
                   const pluralHeader = header.endsWith('y') ? header.slice(0, -1) + 'ies' : header + 's';
                   select.innerHTML = `<option value="">All ${pluralHeader}</option>` +
                       uniqueValues.map(value => `<option value="${value}">${value}</option>`).join('');
                  
                   if (uniqueValues.includes(currentValue)) {
                       select.value = currentValue;
                   } else {
                       select.value = '';
                   }
               }
           });
       }

       function filterTable() {
           const filteredData = getFilteredData();
           renderTable(filteredData);
       }

       function sortTable(column) {
           if (sortColumn === column) {
               // Toggle direction if clicking the same column
               sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
           } else {
               // Set new column and default to ascending
               sortColumn = column;
               sortDirection = 'asc';
           }
           currentPage = 1; // Reset to first page on sort
           filterTable();
       }

       function renderTable(data = allData) {
           const tableHeader = document.getElementById('tableHeader');
           const tableBody = document.getElementById('tableBody');
           const prevPageBtn = document.getElementById('prevPageBtn');
           const nextPageBtn = document.getElementById('nextPageBtn');

           // Render headers with sort indicators
           tableHeader.innerHTML = '<tr>' + headers.map(header => `
               <th onclick="sortTable('${header}')">
                   ${header}
                   <span class="sort-indicator">
                       ${sortColumn === header ? (sortDirection === 'asc' ? '↑' : '↓') : ''}
                   </span>
               </th>
           `).join('') + '</tr>';
           
           // Paginate data
           const startIndex = (currentPage - 1) * resultsPerPage;
           const endIndex = startIndex + resultsPerPage;
           const paginatedData = data.slice(startIndex, endIndex);

           tableBody.innerHTML = paginatedData.map(row =>
               '<tr>' + headers.map(header => `<td>${row[header]}</td>`).join('') + '</tr>'
           ).join('');

           // Show/hide page buttons
           prevPageBtn.style.display = (currentPage > 1 && resultsPerPage !== Infinity) ? 'inline-block' : 'none';
           nextPageBtn.style.display = (resultsPerPage !== Infinity && endIndex < data.length) ? 'inline-block' : 'none';
       }

       fetchSheetData();
   </script>
</body>
</html>